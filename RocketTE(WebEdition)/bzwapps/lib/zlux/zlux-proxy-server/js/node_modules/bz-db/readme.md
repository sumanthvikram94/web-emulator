# BlueZone Database
## Release notes
### 3.1.10
- Guarantee that queries return the same data entities for inMemory and inLocal data entity
### 3.1.9
- send happyToJoin event after pull all data
- fix connection state issues that the notified node cannot obtain the information of the node that is joining the cluster in time
### 3.1.8
- Never give up when adding meta peers
### 3.1.7
- Avoid data conflict caused by in-complete block appending while pull
- Statistics and pulling will wait for existing block appending to finish
- Append block should wait for existing statistics and pulling to finish
- Workflow and Task now supports task grouping, and function to wait for a group of tasks to finish.
- Store peer connection state, broadcast to the peer that is connected.
- Auto resolve data conflict if enable the conflict resolve policy.
- Resolve the data conflict issue caused by report entities. 
### 3.1.6
- Support function checkinAll 
- Support function pushToPeers which can push specific entities to peers 
- Add conflict infomation when checkStatus function invoked in db-worker.
### 3.1.5
- Add queue to handle auto scale
### 3.1.4
- Extend the auto scale task expiration time to 10 minutes
### 3.1.3
- Enhance logging to track same txn / checkin / pull across all nodes in cluster
- Enhance logging for different kinds of logs
- Record multiple blocks as branches at the same chain index
- Fixed fake conflict status caused by chain history clearing
- Fixed Muxer already closed issue
- Fixed bug in doWritePartitions which cause data pulling issue
- Fixed UT issues
- AutoScaling mode: no longer processes the nodes that are on the peerlist but are already in the cluster
### 3.1.0
- Support yaml file for PersistMethod.PERSIST_METHOD_LIST_FILE + PersistType.PERSIST_TYPE_YAML
- Expose yaml processing function const obj = await bzdb.yamlStrToJson(yamlStr: string) which reads yaml string and return JSON object and keep yaml comments in obj.__bzdb_yaml_metadata.comments
- Expose yaml processing function const yamlStr = await bzdb.jsonToYAMLStr(obj: object) which converts JSON object to yaml string and generate yaml comments according to obj.__bzdb_yaml_metadata.comments
- Expose the stringify function of yaml package as bzdb.yamlStringify(obj). It converts object to yaml string. It doesn't care for comments.
- Expose the parse function of yaml package as bzdb.yamlParse(yamlStr). It parses yaml string as JSON object. It doesn't care for comments.
- Fixed bug for peer:discovery event, the multiaddrs got from peer was wrong.
### 3.0.12
- Enhance for auto-scaling function
### 3.0.11
- Introduced metadata.cluster.proxy.protocol
- Fixed bug for metadata.cluster.proxy.port
### 3.0.10
- Fix bug for data entity lock which caused execution queue stuck
### 3.0.9
- Refactor FILE_WATCH mode to watch for dir for in-memory cached entities
- When valications failed before write file, it won't block the data writing, but print a warning instead
- When working in FILE_WATCH mode, bypass the NFS client cache when read NO-CACHE data entities
- Data entity metadata.isInternal will avoid watching for the data entity
### 3.0.8
- Introduced method to bypass AWS EFS client cache
- Fixed bug for ARRAY type for shared fs
- Fixed bug for batchTxn when cluster is not enabled
### 3.0.7
- Write log into file instead of into stdio, otherwise the log could get lost. Node.js issue: https://github.com/nodejs/node/issues/30491
### 3.0.6
- Fix bugs for shared fs
### 3.0.5
- Fix bugs for shared fs
### 3.0.4
- Refactored the FILE_WATCH data strategy to support shared fs (AWS EFS)
### 3.0.3
- Added cluster.proxy into metadata
### 3.0.2
- Added function getNodeAddrs to get the address of the local node.
### 3.0.1
- Introduced nodeTypes: persistent and scalable
- Fixed bugs for auto-scaling
### 3.0.0
- Enable auto-scaling configurations
- Introduced peer discovery method: mdns
- Introduced peer discovery method: bootstrap
### 2.0.4.1
- Add event handler to deal with data conflict
### 2.0.4
- When starting BZDB, accept log config for file
### 2.0.3
- Fixed bug when mutiple nodes start in a short period time cause the status is 'Lonly Island'
### 2.0.2
- Fixed bug for worker timeout. It was 10 seconds, now changed to 60 seconds
### 2.0.1
- Use the Threads and perf-tracker in BZ project
### 2.0.0
- Changed module type to ES2020 (ECMAScript Module). (Refer to https://nodejs.org/docs/latest-v16.x/api/esm.html)
- Stop support for node.js V12 or below
- Upgrade module typescript from 4.1.5 to 5.0.2
- Upgrade module libp2p from 0.30.8 to 0.42.2
- Upgrade module Jest from 25.1.0 to 29.5.0
- Upgrade module threads from 1.6.3 to 1.7.1 (in jgao's personal repo as temp solution for a bug in ESM)
- Upgrade module lodash from 4.17.19 to 4.17.21
- Upgrade module portfinder from 1.0.28 to 1.0.32
- Upgrade module it-pipe from 1.1.0 to 2.0.5
- Upgrade module fs-extra from 9.1.0 to 11.1.0
- Upgrade module core-js from 2.6.11 to 3.29.1
- Upgrade module chokidar from 3.4.0 to 3.5.3
- Upgrade module better-queue from 3.8.10 to 3.8.12
- Uninstall module request
- Uninstall module leaked-handles
- Uninstall module rxjs and rxjs-compat
- Add new log level SELENT (-1) for UT. No log output even for error when sets loglevel to SELENT
- Add option into database metadata. @param metadata.performance.workOnBusy: boolean. If true, the db won't reject any request even when process is busy
- Refactor for private-net-node.ts code structure
- Refactor for node-metadata.ts data model
- Fixed elu logic to avoid useless log output.
- Fixed bug when dial a peer who is offline. The exception was caught and didn't close the task until the task times out.
- Removed process pooling solution
### 1.5.19
- Introduced field encrytion / decryption for data entities except for RAW data type.
### 1.5.16
- Avoid updating futime of data entity parent folder when it's not DataStrategy.FILE_WATCH
- Fix UT issues
### 1.5.15
- Implement delete with filter for NO_CACHE + LIST_FILE + with PK
### 1.5.13
- Apply filter when select for PERSIST_METHOD_LIST_FILE / PERSIST_METHOD_ONLY_MEMORY data entities
### 1.5.10
- Disable BZDB clustering feature on zowe 2.0
### 1.5.9
- Fix bug for forcePull for data entity with syncFile4Cluster: true
- Fix bug for cached data entity analysis
### 1.5.8
- Upgrade perf-tracker to 0.1.1
### 1.5.7
- Fix bug for getFileSyncInfo in worker mode.
### 1.5.6
- Support listening on specific host Ip
### 1.5.5
- Fix typo in IntegratyLevel.INTEGRATY_WEAK
### 1.5.4
- Add IntegratyLevel into data entity metadata. IntegratyLevel.INTEGRATY_WEAK will allow data change in the DE even in data conflict, except for the conflic exists in the same DE.
- Fix bug when exec cmd in cluster, no reply returned.
### 1.5.3
- Add AnalyzeMethod.ANALYZE_METHOD_FILE_SIZE for NO_CACHE
- Add partitions() to internal DB to get data by partition (file)
- Add writePartitions() to internal DB to overwrite data with provided partitions data
- Changed fully pull process to utilize partitions() and writePartitions()
- Enable cache for Data Entity Analysis except for NO_CACHE DEs
### 1.5.2
- Enable enableWorkerThread: true
- Add event loop utilization tracking
- Add silent mode for transactions
- Changed thread name for manager and worker
### 1.4.7
- Replace fs with fs-extra to avoid too many files open error
### 1.4.6
- Fix bug for get statistics
### 1.4.5
- Timeout the select cluster and broadcast in 60 seconds if no reply
### 1.4.4
- Let append block(s) and get statistics to wait for each other
- Timeout the status check in 60 seconds if no reply
### 1.4.3
- Reduce info level log
### 1.4.2
- Fix bug for block index update
### 1.4.1
- Fix bug for snapshot
- Fix bug for exit when port is in use
### 1.4.0
- Support create entity, create temp entity
- Support drop entity, drop  temp entity
- Await for pulling completes before respond for checkin
- Introduce block chain self validation
- Changed block hash from timestamp to UID
- Refactor batch txn
- Refactor file transfer
- Fix bug in batch txn
### 1.3.15
- Exit the process in case cluster port is in use and in cluster mode
- Introduce developmentMode into peerInfo
### 1.3.14
- Fix bug for block index updating for batch txn
### 1.3.13
- Introduce redundent block data into block, redundent size is related to count of peers
- When received future block, try to fill the lost blocks with the redundent block data of the future block
- Introduce touch event to block chain
- Enhance pending block validation logic, introduced compete factor when block timestamp is the same as local pending block
- Enhance block index update logic, wait for 200 ms or the touch event of chain
- Changed PK format to timestamp number when PK is a Date
- Fix bug for frequent data conflict issue
- Fix bug for pending block lost issue
### 1.3.12
- Fix bug for select memory task time out when select in cluster
### 1.3.11
- Introduce parameters to the exec function
- Fix bug in build.js when patch number > 10
### 1.3.10
- Introduce registerCommand function, so different peers can exec the same registered command.
- Record the index for approved blocks
- Fix bug in pending block recording for concurrent local txn
- Fix bug for port scanning for ipv6
- Fix bug in block validation
### 1.3.9
- Support create temp entity - createTempEntity
- Support destroy temp entity - destroyTempEntity
- Fix bug when calculate hash key for string
### 1.3.8
- Write version into node metadata and peer metadata
- Verify version in metadata when introduce node
- Allow kicking offline peer
- Changed the action when recieved msg from unknown node on private channel. 
  - New action: respond rejection back to the node
  - Old action: doesn't respond any msg
- Fixed bug in free port scanning
- Fixed bug when checkin with kicked peer
- Fixed bug to avoid error when data file is emtpy
### 1.3.7
- When in not listening status, reject the introduceNode
- When being introduced, clear the data entities that are memory only or local storage only
- Return inNet:true for status check from old version (message was not zipped)
- Timeout the status check in 10 seconds if no reply
- Reject introduceNode if checkstatus timesout
- Fixed bug in task timeout
- Fixed bug in message sender. Didn't await for ensure if sender exists but connection broken
- Fixed bug when sending task to a peer that is kicked
### 1.3.6
- Change checkStatus to return data for offline peers
- Fixed bug in peer:disconnect event after kickNode
- File sync enhancements
  - add taskId in FileSyncMsg and merge multiple FileSyncMsgs to one
  - create a Promise to send file to avoid blocking the main BZDB thread.
  - reuse one stream for channel FILE_TRANSFER_RES to save time
  - improve pullAll process to only transfer the files when file size is different
### 1.3.5
- Introduced bzdb.exec(cmd, peerId?) to execute the cmd on local or peer node
- Introudced 'shutdown' command, so a peer node can be shutdown remotely
- Fix bug in data entity statistics for no_cache
### 1.3.4
- Reject introduce request for non-compatible application
- Reject introduce request for non-compatible version
- Fix bug in timeout clearing
- Fix bug in out of date status
### 1.3.3
- Introduce DB version (major.minor.patch)
- Auto-tagging on level of patch, minor or major
- Fix bug in filter clearing
### 1.3.2
- Change block metadata storage to 200 partitions
- File sync enhancements
### 1.3.1
- Starts a new server with fixed port "8643"
- In case 8643 is in use, increase the port until finding a free port
- In singleton mode, if port is in use, the DB still can start, but with listening status as false
- When clearing blocks, keep at most 1000 blocks, even the blocks are created within one week. Purpose is to control the total size of blocks.
- Fixed bug in PERSIST_TYPE_ARRAY for bulkloading
### 1.3.0
- Add new data storage method for NO_CACHE with partitioned files
- Enable partition with non-PK columns and specifying parition count

## Installation
        Add below line into your package.json
        "bz-db": "git+ssh://git@git.rocketsoftware.com:7999/~jgao/bzdb.git#v1.3.1"
        Then execute npm install
## Usage
```Javascript
        // First, require the database package
        const BZDB = require('bz-db');
        // Then define the metadata.
        const metadata = new BZDB.DatabaseMetadata({
            storePath: './testdata/',
            dataEntities: [
                {name: 'user', primaryKeys:['id']}
            ],
            onLoadReady: (results: any) => {
                console.log('Database load ready');
            }
        });
        // Load database with the metadata
        const bzdb = BZDB.loadDatabase(metadata);
        // Wait until the DB is started.
        const bzdb.waitLoadReady();
        // Use the database
        await bzdb.insert('user', {id: '1', name: 'Jerry', role: 'ENGINEER', gender: 'male', age: '40'});
        const selData = await bzdb.select('user', {id: '1'});
```
## APIs
        select(dataEntityName: string, filter?: Object, options?: Object): Promise<any>

        Example:
```Javascript
        const selData = await bzdb.select('user', {role: 'engineer'}, {
            ignoreCaseFields: ['role'],
            orderBy: {fields: ['gender', 'age'], orders: ['asc', 'desc']},
            pagination: {page: 3, size: 10}
        });
```

        delete(dataEntityName: string, filter: any, options?: Object): Promise<any>

        insert(dataEntityName: any, value: any): Promise<any>

        update(dataEntityName: any, filter:any, value: any, constraints?: Object): Promise<any>

        updateOrInsert(dataEntityName: any, value: any): Promise<any>

        bulkLoad(dataEntityName: string, values: any[], constraint: BulkLoadConstraints): Promise<any>

        waitLoadReady(): Promise<any>
## Unit test
        Execute below command to run unit test: 
        npm t
